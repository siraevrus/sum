name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment process..."
          
          # Navigate to project directory
          cd /var/www/html
          echo "ğŸ“ Changed to project directory: $(pwd)"
          
          # Create backup before deployment
          echo "ğŸ’¾ Creating backup..."
          BACKUP_DIR="/var/backups/sklad/$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          cp -r /var/www/html "$BACKUP_DIR/"
          echo "âœ… Backup created at: $BACKUP_DIR"
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from main branch..."
          git fetch origin
          git reset --hard origin/main
          echo "âœ… Code updated successfully"
          
          # Install/update PHP dependencies
          echo "ğŸ“¦ Installing PHP dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction
          echo "âœ… PHP dependencies installed"
          
          # Install/update Node dependencies and build assets
          echo "ğŸ¨ Building frontend assets..."
          npm ci --production
          npm run build
          echo "âœ… Frontend assets built"
          
          # Generate application key if not exists
          echo "ğŸ”‘ Generating application key..."
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          # Temporarily disable database connection for key generation
          sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env
          php artisan key:generate --force
          echo "âœ… Application key generated"
          
          # Configure MySQL database
          echo "ğŸ—„ï¸ Configuring MySQL database..."
          sed -i 's/DB_CONNECTION=sqlite/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=127.0.0.1/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=3306/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=laravel/DB_DATABASE=sklad/' .env
          sed -i 's/DB_USERNAME=root/DB_USERNAME=sklad/' .env
          sed -i 's/DB_PASSWORD=/DB_PASSWORD=sklad123/' .env
          echo "âœ… MySQL database configured"
          
          # Run database migrations
          echo "ğŸ—„ï¸ Running database migrations..."
          php artisan migrate --force
          echo "âœ… Database migrations completed"
          
          # Clear and cache configuration
          echo "ğŸ§¹ Clearing and caching configuration..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan cache:clear
          
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          echo "âœ… Configuration cached"
          
          # Set proper permissions
          echo "ğŸ” Setting proper permissions..."
          chown -R www-data:www-data /var/www/html
          chmod -R 755 /var/www/html
          chmod -R 775 /var/www/html/storage
          chmod -R 775 /var/www/html/bootstrap/cache
          echo "âœ… Permissions set"
          
          # Restart services
          echo "ğŸ”„ Restarting services..."
          systemctl restart nginx
          systemctl restart php8.4-fpm
          echo "âœ… Services restarted"
          
          # Verify deployment
          echo "âœ… Verifying deployment..."
          php artisan --version
          php artisan config:show app.name
          
          # Health check
          echo "ğŸ¥ Running health check..."
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "âœ… Health check passed - application is running"
          else
            echo "âŒ Health check failed - application may not be running properly"
            exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Deployment summary:"
          echo "   - Code updated from main branch"
          echo "   - Dependencies installed and optimized"
          echo "   - Database migrated"
          echo "   - Configuration cached"
          echo "   - Frontend assets built"
          echo "   - Permissions set"
          echo "   - Services restarted"
          echo "   - Health check passed"
